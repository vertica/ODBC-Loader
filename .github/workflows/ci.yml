name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up MySQL server
        run: |
          docker run -d -p 3306:3306 -e MYSQL_ALLOW_EMPTY_PASSWORD=yes --name test-mysql mysql:8.0
          echo "MySQL startup ..."
          until docker exec test-mysql mysql -u root -e "SELECT 1;"; do \
            echo "..."; \
            sleep 1; \
          done;
          docker exec -u root test-mysql mysql -u root -e "CREATE DATABASE testdb;"
          docker exec -u root test-mysql mysql -u root testdb -e "CREATE TABLE test_source (i integer, b boolean, f float, v varchar(32), c char(32), lv varchar(9999), bn binary(32), vb varbinary(32), lvb varbinary(9999), d date, t time, ts timestamp null, tz varchar(80), tsz varchar(80), n numeric(20,4));"
          docker exec -u root test-mysql /bin/bash -c "(echo \"INSERT INTO test_source VALUES (null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);\"; for i in \`seq 1 9\`; do echo \"INSERT INTO test_source VALUES (\$i, 1, \$i.5, 'test \$i', 'test \$i', 'test \$i', 'test \$i', 'test \$i', 'test \$i', '\$((\$i+11))00/1/\$i', '4:0\$i', '2038-01-0\$i 03:14:07', '1:2\$i:00', 'June 1, \$((\$i+11))00 03:2\$i EST', '123456.7890');\"; done) | mysql -u root testdb"
          docker exec -u root test-mysql mysql -u root testdb -e "select * from test_source;"

      # ---------------------------
      # Kubernetes (KinD) + Helm setup
      # ---------------------------
      - name: Set up Kubernetes (KinD)
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: vertica-ci
          node_image: kindest/node:v1.29.0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.11.3"

      - name: Build custom Vertica image with ODBC
        run: |
          cat <<EOF > Dockerfile
          FROM opentext/vertica-k8s:latest
          USER root
          # Enable config manager and CRB (needed on some EL9 images for extra packages)
          RUN dnf -y install dnf-plugins-core || true
          RUN dnf config-manager --set-enabled crb || true
          # Install base ODBC packages and common build deps
          RUN dnf -y install unixODBC unixODBC-devel pcre-devel perl make || true
          # Download MySQL ODBC RPM and install locally (use --nogpgcheck to avoid key issues)
          RUN curl -L -o /tmp/mysql-connector-odbc.rpm https://dev.mysql.com/get/Downloads/Connector-ODBC/8.0/mysql-connector-odbc-8.0.36-1.el9.x86_64.rpm && \
              dnf -y install /tmp/mysql-connector-odbc.rpm --nogpgcheck || true
          # Install GCC toolset if available (not fatal if unavailable)
          RUN dnf -y install gcc-toolset-12-gcc-c++ || true
          USER dbadmin
          EOF
          docker build -t vertica-odbc:latest .
          kind load docker-image vertica-odbc:latest --name vertica-ci

      - name: Verify custom image loaded into KinD node
        run: |
          set -e
          NODE=vertica-ci-control-plane
          echo "Checking for vertica-odbc image on the runner (docker)"
          if docker images | grep -q vertica-odbc; then
            echo "Found vertica-odbc locally. Proceeding to check Kind node"
          else
            echo "ERROR: vertica-odbc image not found on the runner. Docker build may have failed."
            echo "Run 'docker images | grep vertica-odbc' locally to inspect.";
            docker images || true
            exit 1
          fi

          echo "Checking for vertica-odbc image on Kind node: $NODE (containerd namespace k8s.io)"
          # check containerd k8s.io namespace where kind stores images
          if docker exec "$NODE" ctr -n k8s.io images ls | grep -q vertica-odbc; then
            echo "vertica-odbc found in Kind node containerd (k8s.io namespace)"
          else
            echo "vertica-odbc NOT found in Kind node; attempting to reload the image into KinD"
            kind load docker-image vertica-odbc:latest --name vertica-ci || true
            echo "Listing images on Kind node after reload (ctr -n k8s.io images ls):"
            docker exec "$NODE" ctr -n k8s.io images ls || true
            # final check
            if docker exec "$NODE" ctr -n k8s.io images ls | grep -q vertica-odbc; then
              echo "vertica-odbc loaded successfully into Kind node after retry"
            else
              echo "ERROR: vertica-odbc image still not present on Kind node '$NODE'."
              echo "Kind load may have failed or the control-plane container name differs."
              echo "Available images on Kind node:"
              docker exec "$NODE" ctr -n k8s.io images ls || true
              exit 1
            fi
          fi

      - name: Add Helm repositories
        run: |
          helm repo add vertica-charts https://vertica.github.io/charts
          helm repo add bitnami https://charts.bitnami.com/bitnami || true
          helm repo update

      # ---------------------------
      # MinIO Setup
      # ---------------------------
      - name: Install MinIO
        run: |
          kubectl create ns minio
          cat <<'EOF' > minio.yaml
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: minio
            namespace: minio
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: minio
            template:
              metadata:
                labels:
                  app: minio
              spec:
                containers:
                  - name: minio
                    image: minio/minio:latest
                    args: ["server", "/data"]
                    env:
                      - name: MINIO_ROOT_USER
                        value: "minioadmin"
                      - name: MINIO_ROOT_PASSWORD
                        value: "minioadmin"
                    ports:
                      - containerPort: 9000
                    volumeMounts:
                      - name: data
                        mountPath: /data
                volumes:
                  - name: data
                    emptyDir: {}
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: minio
            namespace: minio
          spec:
            selector:
              app: minio
            ports:
              - port: 9000
                targetPort: 9000
          EOF
          kubectl apply -f minio.yaml
          kubectl -n minio rollout status deployment/minio --timeout=2m
          kubectl get pods -n minio -o wide || true
          kubectl get svc -n minio || true

      - name: Ensure MinIO bucket exists
        run: |
          kubectl run mc-client --rm -i --restart=Never \
            --image=minio/mc:latest \
            -n minio \
            --command -- bash -c "
              mc alias set localminio http://minio.minio.svc.cluster.local:9000 minioadmin minioadmin && \
              mc mb --ignore-existing localminio/vertica-fleeting && \
              mc ls localminio
            "

      - name: Create MinIO Secret
        run: |
          kubectl create ns my-verticadb-operator
          kubectl delete secret communal-creds -n my-verticadb-operator --ignore-not-found
          kubectl create secret generic communal-creds \
            -n my-verticadb-operator \
            --from-literal=accesskey="minioadmin" \
            --from-literal=secretkey="minioadmin"
          kubectl get secret communal-creds -n my-verticadb-operator -o yaml || true

      # ---------------------------
      # Vertica Operator + DB Deployment
      # ---------------------------
      - name: Install Vertica Operator
        run: |
          cat <<'EOF' > operator-values.yaml
          installCRDs: true
          controller:
            extraEnv:
              - name: AWS_REGION
                value: "us-east-1"
              - name: AWS_DEFAULT_REGION
                value: "us-east-1"
          EOF
          helm upgrade --install vdb-op vertica-charts/verticadb-operator \
            -n my-verticadb-operator -f operator-values.yaml --wait --timeout 10m
          kubectl -n my-verticadb-operator get pods -o wide || true

      - name: Deploy VerticaDB and per-node Services
        run: |
          cat <<'EOF' | kubectl apply -f -
          apiVersion: vertica.com/v1
          kind: VerticaDB
          metadata:
            name: verticadb-sample
            namespace: my-verticadb-operator
            annotations:
              vertica.com/k-safety: "0"
          spec:
            image: vertica-odbc:latest
            imagePullPolicy: Never
            dbName: vdb
            initPolicy: Create
            communal:
              path: s3://vertica-fleeting/mkottakota/
              credentialSecret: communal-creds
              endpoint: http://minio.minio.svc.cluster.local:9000
              region: us-east-1
            local:
              dataPath: /data
              depotPath: /depot
            subclusters:
              - name: defaultsubcluster
                size: 1
          EOF

      - name: Debug VerticaDB deployment
        run: |
          NS=my-verticadb-operator
          kubectl describe verticadb verticadb-sample -n "$NS" || true
          kubectl get events -n "$NS" --sort-by=.metadata.creationTimestamp | tail -20 || true

      - name: Wait for Vertica readiness
        run: |
          NS=my-verticadb-operator
          SS=verticadb-sample-defaultsubcluster
          POD=${SS}-0
          for i in {1..30}; do
            kubectl get pod ${POD} -n ${NS} && break || sleep 10
          done
          kubectl wait --for=condition=Ready pod/${POD} -n ${NS} --timeout=5m

      - name: Collect debug info (images & pod)
        if: failure()
        run: |
          set -e
          NODE=vertica-ci-control-plane
          echo "--- Local docker images ---"
          docker images || true
          echo "--- Docker containers (showing kind control-plane candidate names) ---"
          docker ps --format '{{.Names}} {{.Image}}' || true
          echo "--- Inspecting Kind control-plane container: $NODE ---"
          if docker ps --format '{{.Names}}' | grep -q "$NODE"; then
            echo "Found control-plane container $NODE; listing containerd images (k8s.io namespace)"
            docker exec "$NODE" ctr -n k8s.io images ls || true
          else
            echo "Control-plane container '$NODE' not found; listing available containers for debug:"
            docker ps --format '{{.Names}} {{.Image}}' || true
          fi

          echo "--- Kubernetes: Vertica pod describe & recent events ---"
          kubectl -n my-verticadb-operator describe pod verticadb-sample-defaultsubcluster-0 || true
          kubectl -n my-verticadb-operator get events --sort-by=.metadata.creationTimestamp | tail -30 || true

      # ---------------------------
      # Build + Test
      # ---------------------------
      - name: Build UDx using custom image
        run: |
          docker run --rm -v $(pwd):/src vertica-odbc:latest bash -c '
            cd /src &&
            scl enable gcc-toolset-12 "make"
          '

      - name: Copy lib and ddl to Vertica pod
        run: |
          NS=my-verticadb-operator
          kubectl cp lib/ODBCLoader.so "$NS"/verticadb-sample-defaultsubcluster-0:/tmp/lib/ODBCLoader.so -c server -n "$NS"
          kubectl cp ddl/install.sql "$NS"/verticadb-sample-defaultsubcluster-0:/tmp/install.sql -c server -n "$NS"

      - name: Install UDx from Vertica pod
        run: |
          NS=my-verticadb-operator
          kubectl exec -n "$NS" verticadb-sample-defaultsubcluster-0 -c server -- bash -c 'cd /tmp && /opt/vertica/bin/vsql -U dbadmin -d vdb -f install.sql'

      - name: Copy repo to Vertica pod for testing
        run: |
          NS=my-verticadb-operator
          kubectl cp . "$NS"/verticadb-sample-defaultsubcluster-0:/var/odbc-loader -c server

      - name: Run ODBC Loader Tests in Vertica pod
        run: |
          NS=my-verticadb-operator
          SS=verticadb-sample-defaultsubcluster
          POD=${SS}-0
          kubectl exec -n "$NS" ${POD} -c server -- bash -c 'cp /var/odbc-loader/tests/config/odbc.ini /etc/odbc.ini && cp /var/odbc-loader/tests/config/odbcinst.ini /etc/odbcinst.ini && cd /var/odbc-loader && make test'
      
      - name: Teardown resources
        if: always()
        run: |
          set -e
          # Delete the VerticaDB custom resource and wait a short while for cleanup
          kubectl delete verticadb verticadb-sample -n my-verticadb-operator --ignore-not-found || true
          sleep 3
          # Uninstall the operator release (if installed)
          helm uninstall vdb-op -n my-verticadb-operator || true
          # Delete namespaces created for the CI run
          kubectl delete ns my-verticadb-operator --ignore-not-found || true
          kubectl delete ns minio --ignore-not-found || true
          # Stop the local MySQL container used for tests
          docker rm -f test-mysql || true
          # Delete the KinD cluster created for this workflow
          if command -v kind >/dev/null 2>&1; then
            kind delete cluster --name vertica-ci || true
          fi



