name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # 1. Login to Docker Hub to pull your private image
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: mkottakota419
        password: ${{ secrets.DOCKER_PASSWORD }} # Ensure this secret is set in GitHub Settings

    - name: Set up MySQL server
      run: |
        docker run -d -p 3306:3306 -e MYSQL_ALLOW_EMPTY_PASSWORD=yes --name test-mysql mysql:8.0
        echo "MySQL startup ..."
        until docker exec test-mysql mysql -u root -e "SELECT 1;"; do
          echo "..."
          sleep 1
        done
        docker exec -u root test-mysql mysql -u root -e "CREATE DATABASE testdb;"
        docker exec -u root test-mysql mysql -u root testdb -e "CREATE TABLE test_source (i integer, b boolean, f float, v varchar(32), c char(32), lv varchar(9999), bn binary(32), vb varbinary(32), lvb varbinary(9999), d date, t time, ts timestamp null, tz varchar(80), tsz varchar(80), n numeric(20,4));"
        docker exec -u root test-mysql /bin/bash -c "(echo \"INSERT INTO test_source VALUES (null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);\"; for i in \`seq 1 9\`; do echo \"INSERT INTO test_source VALUES (\$i, 1, \$i.5, 'test \$i', 'test \$i', 'test \$i', 'test \$i', 'test \$i', 'test \$i', '\$((\$i+11))00/1/\$i', '4:0\$i', '2038-01-0\$i 03:14:07', '1:2\$i:00', 'June 1, \$((\$i+11))00 03:2\$i EST', '123456.7890');\"; done) | mysql -u root testdb"

    - name: Set up Vertica server (Private Image)
      timeout-minutes: 15
      run: |
        docker run -d -p 5433:5433 -p 5444:5444 \
          --add-host=host.docker.internal:host-gateway \
          --name vertica_docker \
          mkottakota419/vertica-ci:latest

        echo "Preparing system environment..."
        # 1. Install tools. 
        # 2. Try to link, but don't fail if it's already there (|| true).
        # 3. Verify the path exists so we can see it in the logs.
        docker exec -u root vertica_docker bash -c "
          dnf install -y iproute procps-ng && \
          ln -sf /usr/sbin/ip /sbin/ip || true && \
          ls -l /sbin/ip"
        
        echo "Cleaning stale files..."
        docker exec -u root vertica_docker bash -c "rm -rf /catalog/* /data/*"
        
        echo "Creating Vertica Database (mydb) ..."
        docker exec -u dbadmin vertica_docker admintools -t create_db \
          -s localhost \
          -d mydb \
          -p "MySecretPass"
        
        echo "Vertica is up"
        docker exec -u dbadmin vertica_docker vsql -w "MySecretPass" -c "SELECT version();"

    - name: Build & Install UDx
      run: |
        # 1. Create the directory
        docker exec -u root vertica_docker mkdir -p /var/odbc-loader
        
        # 2. Copy the CONTENTS of the workspace (note the trailing /.)
        # This ensures the Makefile is at /var/odbc-loader/Makefile
        docker cp ${{ github.workspace }}/. vertica_docker:/var/odbc-loader
        
        # 3. Fix permissions
        docker exec -u root vertica_docker chown -R dbadmin:verticadba /var/odbc-loader
        
        # 4. List files to verify (helps debugging)
        docker exec -u dbadmin -w /var/odbc-loader vertica_docker ls -R
        
        # 5. Run the build (make)
        docker exec -u dbadmin -w /var/odbc-loader vertica_docker \
          scl enable gcc-toolset-12 "make"

        # 6. Run install with the password provided to vsql
        # We set VSQL_PASSWORD which vsql recognizes automatically
        docker exec -u dbadmin -w /var/odbc-loader -e VSQL_PASSWORD="MySecretPass" vertica_docker \
          scl enable gcc-toolset-12 "make install"

    - name: Install ODBC clients
      run: |
        # 1. Install wget so we can download the repo file
        docker exec -u root vertica_docker dnf install -y wget

        # 2. Download and install MySQL repo
        docker exec -w /var/odbc-loader -u root vertica_docker wget https://repo.mysql.com/mysql80-community-release-el8-9.noarch.rpm
        docker exec -w /var/odbc-loader -u root vertica_docker dnf install -y mysql80-community-release-el8-9.noarch.rpm
        
        # 3. Install the connector (disabling GPG check to avoid prompt blocks)
        docker exec -w /var/odbc-loader -u root vertica_docker dnf install -y --nogpgcheck mysql-connector-odbc

    - name: Run Tests
      run: |
        # We need to tell the ODBC Driver Manager where to find your odbc.ini and odbcinst.ini
        # These are located in /var/odbc-loader/tests/config based on your 'ls -R' earlier
        
        docker exec -w /var/odbc-loader \
          -u dbadmin \
          -e ODBCSYSINI=/var/odbc-loader/tests/config \
          -e VSQL_PASSWORD="MySecretPass" \
          vertica_docker make test